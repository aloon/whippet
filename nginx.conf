user root;
worker_processes 4;

load_module modules/ngx_http_image_filter_module.so;

events {  
    worker_connections 1024;
}

http {

    server {
        listen 5000;
        
        # include /etc/nginx/mime.types;
        # default_type application/octet-stream;
        
        gzip on;
        gzip_http_version 1.0;
        gzip_comp_level 2;
        gzip_proxied any;
        gzip_vary off;
        #gzip_buffers
        gzip_types text/plain text/css application/x-javascript text/xml application/xml application/rss+xml application/atom+xml text/javascript application/javascript application/json text/mathml;
        gzip_min_length  1000;
        gzip_disable     MSIE [1-6]\.;
        
       # perl_modules perl/lib;
       # perl_require validator.pm;
        
      
      location /favicon.ico {
        empty_gif;
        access_log    off;
        log_not_found off;
      }
        
        
        location / {
            root /data/www;
        }
        
        
        location /healthcheck {
            default_type                 text/plain;
            return 200 "OK";
        }
        
        location /echo.txt {
            return 200 "$arg_width $arg_height $arg_key";
        }
        
        location /crop.jpg {

            alias /data/www/lobo.jpg;
            
            #add_header X-Asset-Location $hostname;            
            #set $bucket "fotoscnet";            
            #rewrite .* $arg_key break;
            #proxy_pass_request_headers off;
            #proxy_buffering off;
            #proxy_next_upstream error timeout http_500 http_502 http_503 http_504;
            #proxy_set_header Host $bucket.s3.amazonaws.com;
            #proxy_pass http://s3.amazonaws.com;
            #proxy_hide_header "x-amz-id-2";
            #proxy_hide_header "x-amz-request-id";
            
            image_filter crop $arg_width $arg_height;
            image_filter_jpeg_quality 75;
            image_filter_buffer 8M;
            
            #allow 127.0.0.0/8;
            #deny all;        
        }
        
        
        location ~ /(.+).jpg/(\d+)x(\d+)cut/ {
            rewrite ^/(.+).jpg/(\d+)x(\d+)cut/ /crop.jpg?width=$2&height=$3&key=$1.jpg break;
            proxy_pass http://127.0.0.1:5000;
        }
        

        
    }
}