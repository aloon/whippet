user root;
worker_processes 4;



events {  
    worker_connections 1024;
}

http {

    server {
        listen 5000;
        
        include /etc/nginx/mime.types;
        default_type application/octet-stream;
        
        gzip on;
        gzip_http_version 1.0;
        gzip_comp_level 2;
        gzip_proxied any;
        gzip_vary off;
        #gzip_buffers
        gzip_types text/plain text/css application/x-javascript text/xml application/xml application/rss+xml application/atom+xml text/javascript application/javascript application/json text/mathml;
        gzip_min_length  1000;
        gzip_disable     MSIE [1-6]\.;
        
       # perl_modules perl/lib;
       # perl_require validator.pm;
        
      
      location /favicon.ico {
        empty_gif;
        access_log    off;
        log_not_found off;
      }
        
        
        location / {
            root /data/www;
        }
        
        
        location /healthcheck {
            default_type                 text/plain;
            return 200 "OK";
        }

        location /lab.jpg {
            default_type                 image/jpeg;
            alias /data/www/lobo.jpg;
            #image_filter resize 100 -;
            #image_filter_jpeg_quality 75;
            #image_filter_buffer 8M;
        
            #default_type                 text/plain;
            #set $text "whippet Â¿?";
            #return 200 $text;
        }
        
        location ~* ^(.*\.jpg) {
            
            add_header X-Asset-Location $hostname;
            
            set $bucket "fotoscnet";
            set $key $1;
            
            rewrite .* $key break;
            
            #return 200 http://$bucket.s3-eu-west-1.amazonaws.com$1;
            
            proxy_pass_request_headers off;
		
            # let amazon take the buffering load
            proxy_buffering off;

            # let amazon retry a few times if first timeouts are 5xx response
            proxy_next_upstream error timeout http_500 http_502 http_503 http_504;

            proxy_set_header Host $bucket.s3.amazonaws.com;

            proxy_pass http://s3.amazonaws.com;
            proxy_hide_header "x-amz-id-2";
            proxy_hide_header "x-amz-request-id";
            
            
            
            #proxy_pass http://$bucket.s3-eu-west-1.amazonaws.com$key;
        }

        
    }
}